# Shift键正交约束功能说明

## 功能概述

在绘制多边形标注时，按住 **Shift 键**可启用正交约束模式，使绘制的线条自动吸附到横平竖直或45度倾斜方向。

## 使用方法

### 基本操作

1. **启动多边形绘制模式**
   - 按快捷键 `C` 进入多边形绘制模式
   - 或通过菜单/工具栏选择多边形绘制

2. **绘制第一个点**
   - 在图像上点击，创建多边形的第一个顶点

3. **使用Shift约束**
   - **按住 Shift 键**，然后移动鼠标绘制第二个点
   - 此时鼠标光标会**自动吸附**到与上一个点成以下角度的方向：
     - **0°** - 水平向右
     - **45°** - 右上倾斜
     - **90°** - 竖直向上
     - **135°** - 左上倾斜
     - **180°** / **-180°** - 水平向左
     - **-45°** - 右下倾斜
     - **-90°** - 竖直向下
     - **-135°** - 左下倾斜

4. **点击确认**
   - 在约束位置点击鼠标，添加新的顶点

5. **继续绘制**
   - 重复步骤3-4，可持续使用Shift键约束每条边
   - 也可以**松开Shift键**进行自由绘制（混合使用）

6. **完成多边形**
   - 双击或按 `Enter` 完成多边形绘制

## 约束原理

### 角度吸附算法

当按住Shift键时，系统会：

1. **计算当前角度**
   - 根据鼠标位置与上一个点计算连线的实际角度

2. **找到最近约束角度**
   - 将实际角度四舍五入到最近的45度倍数

3. **重新计算位置**
   - 保持鼠标与上一个点的距离不变
   - 按约束后的角度重新计算新点的坐标

### 示例

假设上一个点在 (100, 100)，鼠标移动到 (150, 120)：

- **未按Shift键**：点位置为 (150, 120) - 自由绘制
- **按住Shift键**：
  - 实际角度约 21.8°
  - 约束到最近的45度倍数 = 0° (水平)
  - 新点位置约 (154, 100) - 完全水平

## 适用场景

### 1. 矩形物体标注
标注书籍、文档、屏幕等矩形物体时，使用Shift键可确保边界完全横平竖直。

### 2. 建筑物标注
标注建筑物轮廓时，大部分边界都是水平或垂直的。

### 3. 表格单元格标注
标注表格时，单元格边界通常是规则的矩形。

### 4. 对角线标注
需要绘制精确45度对角线时非常有用。

## 功能特性

### ✅ 支持的功能

- ✅ 多边形绘制模式（Draw Mode: POLYGON）
- ✅ 实时视觉反馈（鼠标移动时实时吸附）
- ✅ 可与自由绘制混合使用
- ✅ 支持8个方向的约束（每45度一个）
- ✅ 保持鼠标与上一点的距离不变

### ❌ 不支持的功能

- ❌ SAM框选模式（已有自动矩形功能）
- ❌ SAM点击模式（自动分割）
- ❌ 修复模式（Repaint Mode）

## 技术实现

### 修改的文件

- **ISAT/widgets/canvas.py**
  - 添加 `math` 模块导入
  - 在 `AnnotationScene.__init__()` 添加 `shift_pressed` 和 `ctrl_pressed` 状态变量
  - 在 `AnnotationScene.mouseMoveEvent()` 添加角度约束逻辑
  - 新增 `AnnotationScene._constrain_to_angle()` 方法实现约束算法
  - 修改 `AnnotationView.keyPressEvent()` 同步shift状态到scene
  - 修改 `AnnotationView.keyReleaseEvent()` 同步shift状态到scene

### 核心代码位置

```
ISAT/widgets/canvas.py
├── Line 3: import math
├── Line 82-83: shift_pressed 和 ctrl_pressed 初始化
├── Line 1241-1245: mouseMoveEvent 中的约束调用
├── Line 1196-1237: _constrain_to_angle() 约束算法实现
└── Line 1478-1494: keyPressEvent/keyReleaseEvent 状态同步
```

## 快捷键参考

| 按键 | 功能 |
|------|------|
| `C` | 切换到多边形绘制模式 |
| `Shift` (按住) | 启用正交约束（横平竖直/45度） |
| 鼠标左键 | 添加顶点 |
| 双击 / `Enter` | 完成多边形 |
| `Esc` | 取消当前绘制 |

## 常见问题

### Q: 为什么有时约束不生效？
**A:** 确保：
1. 当前处于**多边形绘制模式**（按 `C` 切换）
2. 已经绘制了至少**一个点**（第一个点无需约束）
3. **持续按住 Shift 键**（不要松开）

### Q: 可以改成其他角度约束吗（如30度）？
**A:** 当前版本固定为45度倍数。如需自定义，可修改 `canvas.py` 第1228行：
```python
constrained_angle_deg = round(angle_deg / 45.0) * 45.0  # 改45.0为30.0即可约束到30度倍数
```

### Q: 为什么SAM模式不支持？
**A:** SAM框选模式已经自动生成完美矩形，无需额外约束。SAM点击模式是自动分割，也不需要手动约束。

## 版本信息

- **实现日期**: 2025-12-01
- **ISAT版本**: 1.4.7+
- **修改类型**: 功能增强（非破坏性）
- **向后兼容**: ✅ 完全兼容现有功能

---

**作者**: Claude Code Assistant
**项目**: ISAT_with_segment_anything
**仓库**: https://github.com/yatengLG/ISAT_with_segment_anything
